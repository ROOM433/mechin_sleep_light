<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 수면 모니터링 시스템 - 코드 리뷰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
        }
        
        h1 {
            color: #667eea;
            border-bottom: 3px solid #764ba2;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #764ba2;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 4px solid #667eea;
        }
        
        h3 {
            color: #555;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .good {
            color: #28a745;
            font-weight: bold;
        }
        
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
        
        ul, ol {
            margin-left: 30px;
            margin-top: 10px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #667eea;
            color: white;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .badge-success {
            background: #28a745;
            color: white;
        }
        
        .badge-warning {
            background: #ffc107;
            color: #333;
        }
        
        .badge-info {
            background: #17a2b8;
            color: white;
        }
        
        .architecture-diagram {
            background: white;
            padding: 20px;
            border: 2px solid #667eea;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .feature-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-top: 3px solid #667eea;
        }
        
        .feature-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🛏️ ESP32 수면 모니터링 시스템 - 코드 리뷰</h1>
        <p style="color: #666; margin-bottom: 30px;">
            <strong>파일:</strong> esp32_sleep_monitor.ino<br>
            <strong>리뷰 일자:</strong> 2024년<br>
            <strong>목적:</strong> ESP32 기반 스마트 수면 알람 시스템의 코드 구조 및 설계 분석
        </p>

        <!-- 1. 프로젝트 개요 -->
        <div class="section">
            <h2>1. 프로젝트 개요</h2>
            <p>
                이 프로젝트는 ESP32 마이크로컨트롤러를 사용하여 수면 패턴을 모니터링하고, 
                최적의 시간에 알람을 울리는 스마트 수면 알람 시스템입니다.
            </p>
            
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>📊 수면 모니터링</h4>
                    <p>ADXL345 가속도계를 사용한 움직임 감지 및 수면 단계 분석</p>
                </div>
                <div class="feature-card">
                    <h4>💡 조명 제어</h4>
                    <p>AC 디머를 통한 밝기 조절 및 선라이즈(일출 효과) 알람</p>
                </div>
                <div class="feature-card">
                    <h4>🌐 웹 연동</h4>
                    <p>WebSocket을 통한 실시간 데이터 통신 및 원격 제어</p>
                </div>
                <div class="feature-card">
                    <h4>🧪 테스트 모드</h4>
                    <p>모의 센서 및 디머 함수를 통한 하드웨어 없이 테스트 가능</p>
                </div>
            </div>
        </div>

        <!-- 2. 아키텍처 분석 -->
        <div class="section">
            <h2>2. 시스템 아키텍처</h2>
            
            <div class="architecture-diagram">
                <h3>클래스 구조</h3>
                <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
┌─────────────────────────────────────┐
│         SleepMonitor (메인)          │
│  - WebSocket 통신 관리               │
│  - 수면 데이터 수집 및 전송          │
│  - 알람 제어                         │
└──────────────┬──────────────────────┘
               │
       ┌───────┴───────┐
       │               │
┌──────▼──────┐  ┌─────▼──────────┐
│  adxl345    │  │ MockAccelerometer│
│ (실제 센서) │  │  (모의 센서)     │
└─────────────┘  └──────────────────┘
       │
┌──────▼──────────┐
│ DimmerController│
│  (조명 제어)    │
└─────────────────┘
                </pre>
            </div>

            <h3>주요 컴포넌트</h3>
            <table>
                <tr>
                    <th>컴포넌트</th>
                    <th>역할</th>
                    <th>상태</th>
                </tr>
                <tr>
                    <td><code>SleepMonitor</code></td>
                    <td>메인 제어 클래스, WebSocket 통신 및 데이터 관리</td>
                    <td><span class="badge badge-success">완료</span></td>
                </tr>
                <tr>
                    <td><code>adxl345</code></td>
                    <td>실제 ADXL345 가속도계 하드웨어 제어</td>
                    <td><span class="badge badge-success">완료</span></td>
                </tr>
                <tr>
                    <td><code>MockAccelerometer</code></td>
                    <td>하드웨어 없이 테스트 가능한 모의 센서</td>
                    <td><span class="badge badge-success">완료</span></td>
                </tr>
                <tr>
                    <td><code>DimmerController</code></td>
                    <td>AC 디머 제어 (현재 모의 함수, 하드웨어 연결 대기)</td>
                    <td><span class="badge badge-warning">모의</span></td>
                </tr>
                <tr>
                    <td><code>sleep_data</code></td>
                    <td>수면 데이터 구조체 (가속도, 각도, 수면 단계 등)</td>
                    <td><span class="badge badge-success">완료</span></td>
                </tr>
            </table>
        </div>

        <!-- 3. 코드 품질 분석 -->
        <div class="section">
            <h2>3. 코드 품질 분석</h2>

            <h3>✅ 장점</h3>
            <ul>
                <li>
                    <strong>모듈화 설계:</strong> 
                    각 기능이 독립적인 클래스로 분리되어 유지보수가 용이합니다.
                </li>
                <li>
                    <strong>테스트 가능성:</strong> 
                    모의 센서와 디머 함수를 통해 하드웨어 없이도 테스트가 가능합니다.
                </li>
                <li>
                    <strong>확장성:</strong> 
                    실제 하드웨어 함수로 쉽게 교체할 수 있도록 인터페이스가 잘 설계되었습니다.
                </li>
                <li>
                    <strong>디버깅 지원:</strong> 
                    시리얼 모니터를 통한 상세한 피드백이 제공됩니다.
                </li>
                <li>
                    <strong>에러 처리:</strong> 
                    WebSocket 재연결 로직이 구현되어 있습니다.
                </li>
            </ul>

            <h3>⚠️ 개선 사항</h3>
            <ul>
                <li>
                    <strong>메모리 관리:</strong>
                    <code>std::deque</code> 사용은 좋지만, 버퍼 크기 제한(100개)이 하드코딩되어 있습니다.
                    <span class="info">→ 매크로로 정의하여 조정 가능하게 개선 권장</span>
                </li>
                <li>
                    <strong>문자열 처리:</strong>
                    <code>String</code> 클래스 사용이 많아 메모리 단편화 가능성이 있습니다.
                    <span class="info">→ 가능한 경우 <code>char[]</code> 사용 고려</span>
                </li>
                <li>
                    <strong>하드코딩된 값:</strong>
                    WiFi SSID, 비밀번호, 서버 IP가 코드에 직접 포함되어 있습니다.
                    <span class="info">→ EEPROM 또는 SPIFFS에 저장하여 런타임 변경 가능하게 개선</span>
                </li>
                <li>
                    <strong>예외 처리:</strong>
                    I2C 통신 실패 시 재시도 로직이 없습니다.
                    <span class="info">→ 센서 읽기 실패 시 재시도 메커니즘 추가 권장</span>
                </li>
                <li>
                    <strong>타이밍 이슈:</strong>
                    <code>delay(100)</code> 사용으로 블로킹이 발생합니다.
                    <span class="info">→ 비블로킹 타이머 사용 고려 (FreeRTOS 태스크 활용)</span>
                </li>
            </ul>
        </div>

        <!-- 4. 설계 패턴 분석 -->
        <div class="section">
            <h2>4. 설계 패턴 및 아키텍처</h2>

            <h3>사용된 패턴</h3>
            <ol>
                <li>
                    <strong>Strategy Pattern (전략 패턴):</strong>
                    <code>MockAccelerometer</code>와 <code>adxl345</code>가 동일한 인터페이스로 교체 가능
                </li>
                <li>
                    <strong>Observer Pattern (관찰자 패턴):</strong>
                    WebSocket 이벤트 핸들러를 통한 비동기 메시지 처리
                </li>
                <li>
                    <strong>Template Method Pattern:</strong>
                    <code>adxl345</code> 클래스의 템플릿 파라미터를 통한 설정 가능성
                </li>
            </ol>

            <h3>아키텍처 평가</h3>
            <div class="code-block">
// 좋은 설계 예시: 모의 함수와 실제 함수의 인터페이스 일치
class MockAccelerometer {
    sleep_data read_sleep_data();  // 실제 센서와 동일한 인터페이스
};

template&lt;uint8_t DEV, uint8_t RESOLUTION&gt;
class adxl345 {
    sleep_data read_sleep_data();  // 동일한 인터페이스
};
            </div>
            <p class="good">
                ✅ 두 클래스가 동일한 인터페이스를 제공하여 런타임에 쉽게 교체 가능합니다.
            </p>
        </div>

        <!-- 5. 보안 및 안정성 -->
        <div class="section">
            <h2>5. 보안 및 안정성 분석</h2>

            <h3>보안 이슈</h3>
            <table>
                <tr>
                    <th>항목</th>
                    <th>현재 상태</th>
                    <th>권장 사항</th>
                </tr>
                <tr>
                    <td>WiFi 자격 증명</td>
                    <td><span class="error">하드코딩</span></td>
                    <td>EEPROM 또는 암호화된 설정 파일 사용</td>
                </tr>
                <tr>
                    <td>WebSocket 인증</td>
                    <td><span class="warning">없음</span></td>
                    <td>토큰 기반 인증 추가</td>
                </tr>
                <tr>
                    <td>입력 검증</td>
                    <td><span class="good">부분적</span></td>
                    <td>JSON 파싱 에러 처리 강화</td>
                </tr>
            </table>

            <h3>안정성 개선 사항</h3>
            <ul>
                <li>
                    <strong>Watchdog 타이머:</strong> 
                    시스템이 멈출 경우를 대비한 워치독 타이머 추가 권장
                </li>
                <li>
                    <strong>센서 오류 복구:</strong> 
                    I2C 통신 실패 시 자동 재시도 및 오류 보고
                </li>
                <li>
                    <strong>메모리 모니터링:</strong> 
                    힙 메모리 사용량 모니터링 및 경고
                </li>
            </ul>
        </div>

        <!-- 6. 성능 분석 -->
        <div class="section">
            <h2>6. 성능 분석</h2>

            <h3>현재 성능 특성</h3>
            <ul>
                <li><strong>샘플링 주기:</strong> 10Hz (100ms 간격)</li>
                <li><strong>데이터 전송 주기:</strong> 5초마다 버퍼된 데이터 전송</li>
                <li><strong>버퍼 크기:</strong> 최대 100개 데이터 포인트</li>
                <li><strong>WebSocket 폴링:</strong> 매 루프마다 실행</li>
            </ul>

            <h3>최적화 제안</h3>
            <ol>
                <li>
                    <strong>비동기 처리:</strong>
                    FreeRTOS 태스크를 사용하여 센서 읽기와 네트워크 통신을 분리
                </li>
                <li>
                    <strong>데이터 압축:</strong>
                    JSON 대신 바이너리 프로토콜 사용으로 전송량 감소
                </li>
                <li>
                    <strong>적응형 샘플링:</strong>
                    수면 단계에 따라 샘플링 주기 조정 (깊은 잠: 낮은 주기)
                </li>
            </ol>
        </div>

        <!-- 7. 코드 예시 및 개선 제안 -->
        <div class="section">
            <h2>7. 주요 코드 섹션 분석</h2>

            <h3>7.1 모의 센서 구현 (우수 사례)</h3>
            <div class="code-block">
class MockAccelerometer {
    sleep_data read_sleep_data() {
        // 노이즈 추가 및 움직임 시뮬레이션
        // 시리얼 모니터 피드백 포함
        // 실제 센서와 동일한 데이터 구조 반환
    }
};
            </div>
            <p class="good">
                ✅ 실제 센서와 동일한 인터페이스를 제공하여 테스트가 용이합니다.
            </p>

            <h3>7.2 WebSocket 메시지 처리 (개선 가능)</h3>
            <div class="code-block">
void handleServerMessage(const char* message) {
    DynamicJsonDocument doc(1024);
    deserializeJson(doc, message);  // 에러 처리 없음
    
    String command = doc["command"];
    // ... 명령 처리
}
            </div>
            <p class="warning">
                ⚠️ JSON 파싱 실패 시 예외 처리가 없습니다. 
                <code>DeserializationError</code> 체크 추가 권장.
            </p>

            <h3>7.3 개선된 버전 제안</h3>
            <div class="code-block">
void handleServerMessage(const char* message) {
    DynamicJsonDocument doc(1024);
    DeserializationError error = deserializeJson(doc, message);
    
    if (error) {
        char msg[128];
        snprintf(msg, sizeof(msg), 
                 "[WS] JSON parse error: %s", error.c_str());
        st_debug_print(2, msg);
        return;  // 조기 반환으로 안전성 향상
    }
    
    String command = doc["command"];
    if (command.length() == 0) {
        st_debug_print(2, "[WS] Empty command received");
        return;
    }
    // ... 명령 처리
}
            </div>
        </div>

        <!-- 8. 테스트 전략 -->
        <div class="section">
            <h2>8. 테스트 전략</h2>

            <h3>현재 테스트 기능</h3>
            <ul>
                <li>✅ 모의 가속도 센서를 통한 데이터 생성 테스트</li>
                <li>✅ 모의 디머를 통한 조명 제어 테스트</li>
                <li>✅ 시리얼 모니터를 통한 디버깅</li>
            </ul>

            <h3>추가 테스트 권장 사항</h3>
            <ol>
                <li>
                    <strong>단위 테스트:</strong>
                    각 클래스의 메서드를 독립적으로 테스트
                </li>
                <li>
                    <strong>통합 테스트:</strong>
                    WebSocket 통신 및 서버 연동 테스트
                </li>
                <li>
                    <strong>스트레스 테스트:</strong>
                    장시간 실행 및 메모리 누수 검사
                </li>
                <li>
                    <strong>에러 시나리오 테스트:</strong>
                    네트워크 단절, 센서 오류 등 예외 상황 처리
                </li>
            </ol>
        </div>

        <!-- 9. 결론 및 권장 사항 -->
        <div class="section">
            <h2>9. 종합 평가 및 권장 사항</h2>

            <h3>전체 평가</h3>
            <p>
                이 코드는 <span class="good">잘 구조화된 프로젝트</span>입니다. 
                모듈화, 테스트 가능성, 확장성 측면에서 우수한 설계를 보여줍니다.
            </p>

            <h3>우선순위별 개선 사항</h3>
            <table>
                <tr>
                    <th>우선순위</th>
                    <th>개선 사항</th>
                    <th>예상 효과</th>
                </tr>
                <tr>
                    <td><span class="error">높음</span></td>
                    <td>JSON 파싱 에러 처리 추가</td>
                    <td>안정성 향상</td>
                </tr>
                <tr>
                    <td><span class="error">높음</span></td>
                    <td>I2C 통신 재시도 로직</td>
                    <td>센서 오류 복구</td>
                </tr>
                <tr>
                    <td><span class="warning">중간</span></td>
                    <td>WiFi 설정을 EEPROM에 저장</td>
                    <td>유연성 향상</td>
                </tr>
                <tr>
                    <td><span class="warning">중간</span></td>
                    <td>FreeRTOS 태스크 분리</td>
                    <td>성능 및 반응성 향상</td>
                </tr>
                <tr>
                    <td><span class="info">낮음</span></td>
                    <td>데이터 압축 프로토콜</td>
                    <td>네트워크 효율성</td>
                </tr>
            </table>

            <h3>최종 의견</h3>
            <p style="background: #e7f3ff; padding: 15px; border-radius: 5px; border-left: 4px solid #17a2b8;">
                <strong>이 프로젝트는 프로토타입 단계를 넘어서 실용적인 제품으로 발전할 수 있는 
                견고한 기반을 가지고 있습니다.</strong> 특히 모의 함수를 통한 테스트 가능성과 
                모듈화된 설계는 향후 유지보수와 확장에 큰 장점이 될 것입니다. 
                위에 제시한 개선 사항들을 단계적으로 적용하면 더욱 안정적이고 신뢰할 수 있는 
                시스템으로 발전할 수 있을 것입니다.
            </p>
        </div>

        <!-- 10. 참고 자료 -->
        <div class="section">
            <h2>10. 참고 자료 및 추가 정보</h2>
            <ul>
                <li><strong>ESP32 공식 문서:</strong> https://docs.espressif.com/</li>
                <li><strong>ArduinoJson 라이브러리:</strong> https://arduinojson.org/</li>
                <li><strong>ArduinoWebsockets:</strong> https://github.com/gilmaimon/ArduinoWebsockets</li>
                <li><strong>ADXL345 데이터시트:</strong> Analog Devices 공식 문서</li>
            </ul>
        </div>

        <footer style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #667eea; text-align: center; color: #666;">
            <p>코드 리뷰 문서 | ESP32 수면 모니터링 시스템</p>
            <p style="font-size: 12px; margin-top: 10px;">이 문서는 코드의 구조, 설계, 품질을 분석한 종합 리뷰입니다.</p>
        </footer>
    </div>
</body>
</html>

