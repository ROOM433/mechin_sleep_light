# 🔧 I2C NACK 오류 해결 가이드

## 🔍 문제 분석

**증상:**
- `I2C hardware NACK detected` 오류 반복 발생
- 일부 데이터는 읽히지만 통신이 불안정
- 센서는 작동하지만 I2C 통신 실패

**원인:**
1. I2C 클럭 속도가 너무 빠름
2. 배선 접촉 불량
3. 풀업 저항 문제
4. 센서 초기화 타이밍 문제
5. 전원 공급 불안정

---

## ✅ 해결 방법

### 1. 배선 확인 (가장 중요!)

센서 핀 연결 확인:
```
ESP32              센서 모듈
------             ---------
3.3V        ────>  VCC (또는 VCC_IN)
GND         ────>  GND
GPIO 21     ────>  SDA
GPIO 22     ────>  SCL
```

**체크리스트:**
- [ ] 모든 배선이 단단히 연결되었는가?
- [ ] 배선이 느슨하지 않은가?
- [ ] SDA와 SCL이 서로 바뀌지 않았는가?
- [ ] 전원이 3.3V인가? (5V 절대 금지!)

### 2. 풀업 저항 확인

I2C 버스는 풀업 저항이 필요합니다:
- **SDA** → 3.3V (4.7kΩ 저항)
- **SCL** → 3.3V (4.7kΩ 저항)

**대부분의 센서 모듈에는 풀업 저항이 내장되어 있습니다.**
- 내장되어 있지 않은 경우 추가 필요

### 3. 전원 확인

**VCC_IN vs 3.3V:**
- 센서에 `VCC_IN`과 `3.3V` 핀이 모두 있다면:
  - **VCC_IN**: 외부 전원 입력 (사용 안 함)
  - **3.3V**: 내부 레귤레이터 출력 (이것 사용)

**올바른 연결:**
```
ESP32 3.3V → 센서 3.3V (또는 VCC)
```

### 4. I2C 클럭 속도 조정

코드에서 이미 적용됨:
```cpp
Wire.setClock(100000);  // 100kHz로 낮춤
```

### 5. 재시도 로직

코드에 재시도 로직이 추가되어 통신 실패 시 자동으로 재시도합니다.

---

## 🧪 테스트 방법

### 1. I2C 스캔 테스트

Arduino IDE에서 다음 코드로 센서 주소 확인:

```cpp
#include <Wire.h>

void setup() {
  Serial.begin(115200);
  Wire.begin();
  Wire.setClock(100000);  // 100kHz
  
  delay(1000);
  Serial.println("Scanning I2C bus...");
  
  for (byte addr = 1; addr < 127; addr++) {
    Wire.beginTransmission(addr);
    byte error = Wire.endTransmission();
    
    if (error == 0) {
      Serial.print("Found device at 0x");
      if (addr < 16) Serial.print("0");
      Serial.println(addr, HEX);
    }
  }
}

void loop() {}
```

**예상 출력:**
```
Scanning I2C bus...
Found device at 0x1E  (HMC5883)
Found device at 0x53  (ADXL345)
Found device at 0x68  (ITG3205)
```

**문제가 있으면:**
- 센서가 감지되지 않음 → 배선/전원 확인
- 일부만 감지됨 → 해당 센서 배선 확인

### 2. 배선 저항 테스트

멀티미터로 확인:
- SDA ↔ GND: 약 4.7kΩ (풀업 저항)
- SCL ↔ GND: 약 4.7kΩ (풀업 저항)
- VCC ↔ GND: 무한대 (단락 없음)

---

## 🐛 문제 해결 단계

### 단계 1: 배선 재확인
1. 모든 배선을 뽑았다가 다시 연결
2. 배선이 단단히 고정되었는지 확인
3. 브레드보드 사용 시 접촉 확인

### 단계 2: 전원 확인
1. 멀티미터로 3.3V 전원 측정
2. 전원이 안정적인지 확인 (떨림 없음)
3. GND가 제대로 연결되었는지 확인

### 단계 3: I2C 버스 확인
1. SDA와 SCL이 서로 바뀌지 않았는지 확인
2. 풀업 저항이 있는지 확인
3. 배선 길이가 30cm 이하인지 확인

### 단계 4: 센서별 테스트
1. ADXL345만 연결하여 테스트
2. ITG3205만 연결하여 테스트
3. HMC5883만 연결하여 테스트
4. 어떤 센서에서 오류가 발생하는지 확인

---

## ⚠️ 주의사항

1. **전원 공급:**
   - 반드시 3.3V 사용 (5V 절대 금지)
   - 전원이 안정적인지 확인

2. **배선 길이:**
   - I2C 배선은 가능한 짧게 (30cm 이하)
   - 긴 배선은 노이즈와 통신 오류 유발

3. **접지:**
   - 모든 GND를 공통으로 연결
   - 별도 접지 루프 방지

4. **센서 손상:**
   - 5V를 연결하면 센서가 손상될 수 있음
   - 배선을 확인한 후 전원 연결

---

## 📋 체크리스트

문제 해결 전 확인:

- [ ] 모든 배선이 단단히 연결됨
- [ ] SDA/SCL이 올바르게 연결됨 (바뀌지 않음)
- [ ] 전원이 3.3V로 정확히 공급됨
- [ ] GND가 공통으로 연결됨
- [ ] 풀업 저항이 있음 (또는 모듈에 내장됨)
- [ ] 배선 길이가 30cm 이하
- [ ] I2C 스캔으로 센서가 감지됨
- [ ] 코드에 I2C 클럭 속도 설정됨 (100kHz)

---

## 💡 추가 팁

### 센서가 일부만 작동하는 경우

데이터가 일부 읽히는 것을 보면:
- **ADXL345는 작동 중** (X, Y, Z 값이 나옴)
- **ITG3205나 HMC5883에서 문제 발생 가능**

해결:
1. 해당 센서의 배선만 재확인
2. I2C 주소 확인 (0x68, 0x1E)
3. 센서별로 개별 테스트

### 코드 개선 사항

이미 적용된 개선:
- ✅ I2C 클럭 속도 100kHz로 설정
- ✅ 재시도 로직 추가 (최대 3회)
- ✅ 에러 체크 추가
- ✅ 센서 초기화 대기 시간 추가

---

**문제가 계속되면:**
1. 배선을 완전히 다시 연결
2. 다른 센서 모듈로 테스트
3. ESP32 보드의 다른 I2C 핀 사용 고려 (GPIO 21, 22 외)

